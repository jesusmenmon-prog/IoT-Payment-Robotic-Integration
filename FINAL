#include <WiFi.h>
#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>


// WiFi
const char* ssid = "NOMBRE_DE_TU_RED";     // Ejemplo: "Mi_Casa"
const char* password = "TU_CONTRASEÑA";    // Ejemplo: "********"
WiFiServer server(12345);

// PCA9685
Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver();
#define RELE_VALVULA_1  26  // GPIO26 para válvula 1
#define RELE_VALVULA_2  27  // GPIO27 para válvula 2
#define SERVO_GRIPPER 0
#define SERVO_HOMBRO 1
#define SERVO_CODO 2
#define SERVO_CADERA 3

int pulsoMin = 150;
int pulsoMax = 580;

void setup() {
  Serial.begin(115200);

  // Inicializar PCA9685
  pwm.begin();
  pwm.setPWMFreq(50);

  // Posición inicial del brazo
  moverServo(SERVO_GRIPPER, 120);
  moverServo(SERVO_CODO, 130);
  moverServo(SERVO_HOMBRO, 20);
  moverServo(SERVO_CADERA, 0);
  // Configura los pines como salida
  pinMode(RELE_VALVULA_1, OUTPUT);
  pinMode(RELE_VALVULA_2, OUTPUT);

  // Apaga ambas válvulas al inicio
  digitalWrite(RELE_VALVULA_1, HIGH);
  digitalWrite(RELE_VALVULA_2, HIGH);

  Serial.println("Sistema listo");
  // Conectar a WiFi
  Serial.println("Conectando a WiFi...");
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }
  Serial.println("\nConectado a WiFi. IP: " + WiFi.localIP().toString());

  // Iniciar servidor
  server.begin();
}

void loop() {
  WiFiClient client = server.available();
  if (client) {
    Serial.println("Cliente conectado.");
    String data = client.readStringUntil('\n');
    Serial.println("Datos recibidos: " + data);

    if (data.indexOf("Coca Cola") >= 0) {
      ejecutarRutina();  // Ejecutar movimiento si hay venta de Coca Cola
    }

    client.stop();
    Serial.println("Cliente desconectado.");
  }
}

// Rutina del brazo
void ejecutarRutina() {
  Serial.println("Iniciando rutina: INICIA");
  // Movimiento: inicia
   Serial.println("Moviendo a posición objetivo...");
      Serial.println("Moviendo a posición objetivo...");
      moverSuave(SERVO_CODO, 130, 120);
      delay(2000);  // espera 5 segundos
      moverSuave(SERVO_GRIPPER, 120, 60);
      delay(2000);  // espera 5 segundos
      Serial.println("Moviendo a valvula 1...");
      moverSuave(SERVO_CADERA, 0, 85);
      delay(2000);  // espera 5 segundos
      moverSuave(SERVO_HOMBRO, 20, 65);
      delay(2000);  // espera 5 segundos
      moverSuave(SERVO_CODO, 120,80);
      delay(2000);  // espera 5 segundos

      Serial.println("Activando válvula 1");
      digitalWrite(RELE_VALVULA_2, LOW);
      delay(3000);
      digitalWrite(RELE_VALVULA_2, HIGH);
      Serial.println("Válvula 1 apagada");
      delay(1000);
      Serial.println("Moviendo a valvula 2...");
      moverSuave(SERVO_CADERA, 90, 120);
      delay(2000);  // espera 5 segundos
      moverSuave(SERVO_HOMBRO, 65, 70);
      delay(2000);  // espera 5 segundos
      moverSuave(SERVO_CODO, 80,75);
      delay(2000);  // espera 5 segundos
      
      Serial.println("Activando válvula 2");
      digitalWrite(RELE_VALVULA_1, LOW);
      delay(3000);
      digitalWrite(RELE_VALVULA_1, HIGH);
      Serial.println("Válvula 2 apagada");
      delay(1000);
      
      moverSuave(SERVO_CADERA, 120, 0);
      delay(2000);  // espera 5 segundos
     
      moverSuave(SERVO_GRIPPER, 60, 120);
      delay(2000);  // espera 5 segundos


  Serial.println("Rutina completada: REGRESA");
  // Movimiento: regresa
  

  moverSuave(SERVO_CODO, 75, 130);
  delay(2000);
  moverSuave(SERVO_HOMBRO, 70, 20);
      delay(2000);  // espera 5 segundos
  
 
}

// Funciones auxiliares
void moverServo(uint8_t canal, int angulo) {
  int pulso = map(angulo, 0, 180, pulsoMin, pulsoMax);
  pwm.setPWM(canal, 0, pulso);
}

void moverSuave(uint8_t canal, int angInicio, int angFin) {
  int pasos = 20;
  float paso = (angFin - angInicio) / float(pasos);
  for (int i = 0; i <= pasos; i++) {
    float ang = angInicio + paso * i;
    moverServo(canal, ang);
    delay(100);
  }
}
